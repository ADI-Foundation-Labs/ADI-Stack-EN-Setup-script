# Upgrading External Node from v0.8.4 to v0.10.0

## Overview

This guide covers the upgrade process from External Node v0.8.4 to v0.10.0. **This is NOT a standard upgrade** due to breaking changes that require a full resynchronization from scratch.

## Breaking Changes in v0.10.0

Version 0.10.0 introduces several breaking changes that make it incompatible with the existing chain data:

### zksync-os v0.1.0 Support

The server has been updated to support zksync-os v0.1.0, which includes significant architectural changes:

1. **Merkle Tree**: Implements new traits required for prover input generation 0.1.0
2. **MultiVM Changes**:
   - Adds bins v4
   - Adds `ExecutionVersion::V4` with updated `run_block` and `simulate_tx` methods
   - Introduces `AbiTxSource` for backward compatibility with previous versions
   - Removes temporary kludges (`pubdata_margin` in `estimate_gas`, `rejected_signers`)
   - **BREAKING**: Introduces `ReplayWireFormatV4` with `blob_fee` added to `BlockContext`
     - This is a breaking replay storage change
     - Existing chain data is incompatible with this format

3. **Prover Input Generator**: Now supports both v3 and v4 blocks

### Why Full Resync is Required

The `ReplayWireFormatV4` changes the way block context data is stored and replayed. The addition of `blob_fee` to the `BlockContext` means that:
- Old chain data cannot be read by the new node software
- The replay mechanism is incompatible with previously stored blocks
- A clean slate is necessary to ensure data integrity

## Prerequisites

Before starting the upgrade:

- [ ] **Backup**: Ensure you have backups of any custom configurations (if applicable)
- [ ] **Downtime**: Plan for significant downtime while the chain resyncs from scratch
- [ ] **Coordination**: Confirm with the ADI team that the sequencer node has been upgraded to v0.10.0

## Important Warnings

 **DATA LOSS WARNING**: This upgrade requires deleting all existing chain data. Ensure you understand the implications:
- All locally synced blockchain data will be deleted
- The node will need to resync from block 0

 **COORDINATION REQUIRED**: Do not proceed until the ADI team confirms the sequencer node is upgraded. Starting the sync before the sequencer upgrade may result in syncing incorrect or incompatible data.

## Upgrade Steps

### Step 1: Stop All Services

Completely remove all running containers to ensure a clean shutdown:

```bash
./external-node.sh down
```

Verify all services are stopped:

```bash
./external-node.sh status
```

You should see no running containers for:
- `adi_testnet_external_node`
- `adi_testnet_proof_sync`
- `cloudflared-tcp-proxy`

### Step 2: Remove Existing Chain Data

**WARNING**: This step permanently deletes all chain data. Double-check you're deleting the correct directory.

```bash
# Using default chain data directory
sudo rm -rf ./chain_data/*

# Or if using custom CHAIN_DATA_DIR
sudo rm -rf ${CHAIN_DATA_DIR}/*
```

Verify the directory is empty:

```bash
ls -la ./chain_data/
```

The directory should exist but be empty (only `.` and `..` entries should appear).

### Step 3: Wait for Sequencer Upgrade

**CRITICAL**: Contact the ADI team and wait for confirmation that:
- The sequencer node has been upgraded to v0.10.0
- The sequencer is producing blocks with the new v4 format

**Do not proceed to Step 4 until you receive explicit confirmation.**

### Step 4: Pull Latest External Node Image

Pull the updated v0.10.0-b container image:

```bash
./external-node.sh pull
```

This will download:
```
harbor.sre.ideasoft.io/adi-chain/external-node:v0.10.0-b
```

Verify the image has been updated:

```bash
docker images | grep external-node
```

### Step 5: Download Shared Proofs (Optional but Recommended)

Download the latest proof storage snapshot to speed up initial sync:

```bash
./external-node.sh download
```

Options:
- `--force`: Delete local files that no longer exist in Azure
- `--verbose`: Stream detailed azcopy logs
- `--destination <path>`: Sync to a custom directory

### Step 6: Start the External Node

Ensure your L1 RPC URL is set:

```bash
export GENERAL_L1_RPC_URL="https://your-l1-endpoint"
```

Start all services:

```bash
./external-node.sh start
```

Or pass the L1 RPC URL directly:

```bash
./external-node.sh start --l1-rpc-url https://your-l1-endpoint
```

This will start:
- `external_node` - Main external node service
- `proof-sync` - Automatic proof synchronization sidecar
- `cloudflared-tcp-proxy` - Cloudflare Access proxy for replay endpoint

### Step 7: Monitor Sync Progress

Monitor the external node logs to track synchronization:

```bash
./external-node.sh logs
```

Or follow a specific service:

```bash
docker logs -f adi_testnet_external_node
docker logs -f adi_testnet_proof_sync
```

Look for log entries indicating:
- Successful connection to the main node RPC
- Block processing progress
- No errors related to proof storage

### Step 8: Verify Node Health

Check the node status endpoint:

```bash
curl http://localhost:3071/health
```

Check sync progress:

```bash
curl -X POST http://localhost:3050 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'
```

Compare with the main node:

```bash
curl -X POST https://rpc.ab.testnet.adifoundation.ai/ \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'
```
