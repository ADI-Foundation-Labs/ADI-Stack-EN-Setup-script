services:
  cloudflared-tcp-proxy:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-tcp-proxy
    command: >
      access tcp
      --hostname replay.ab.testnet.adifoundation.ai
      --listener 0.0.0.0:3053
    networks:
      - zkos-net

  proof-sync:
    image: peterdavehello/azcopy:latest
    container_name: adi_testnet_proof_sync
    restart: unless-stopped
    entrypoint: ["/bin/sh", "/sync-proofs.sh"]
    environment:
      PROOF_STORAGE_URL: "${PROOF_STORAGE_URL:-https://adiproofs.blob.core.windows.net/shared}"
      SHARED_PROOF_DIR: "/chain/db/shared"
      SYNC_INTERVAL: "${PROOF_SYNC_INTERVAL:-60}"
      DELETE_DESTINATION: "${PROOF_SYNC_DELETE:-false}"
    volumes:
      - ${CHAIN_DATA_DIR:-./chain_data}:/chain
      - ./sync-proofs.sh:/sync-proofs.sh:ro
    networks:
      - zkos-net

  external_node:
    image: adi-foundation/adi-external-node:latest
    container_name: adi_testnet_external_node
    restart: unless-stopped
    working_dir: /app
    depends_on:
      - cloudflared-tcp-proxy
    environment:
      genesis_bridgehub_address: "0xc1662F0478e0E93Dc6CC321281Eb180A21036Da6"
      genesis_chain_id: 36900
      sequencer_block_replay_download_address: "cloudflared-tcp-proxy:3053"
      general_main_node_rpc_url: "https://rpc.ab.testnet.adifoundation.ai/"
      general_rocks_db_path: "/chain/db/node1"
      prover_api_object_store_file_backed_base_path: "/chain/db/shared"
      sequencer_block_dump_path: "/chain/db/block_dumps"
      sequencer_block_replay_server_address: "0.0.0.0:3054"
      rpc_address: "0.0.0.0:3050"
      status_server_address: "0.0.0.0:3071"
      general_prometheus_port: "3312"
      general_l1_rpc_url: "${GENERAL_L1_RPC_URL}"
      RUST_LOG: "info"
    volumes:
      - ${CHAIN_DATA_DIR:-./chain_data}:/chain
    ports:
      - "3050:3050"
      - "3071:3071"
      - "3054:3054"
      - "3312:3312"
    networks:
      - zkos-net

networks:
  zkos-net:
    driver: bridge